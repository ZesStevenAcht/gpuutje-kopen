<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPUutje kopen?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .header {
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        tbody tr:hover {
            background-color: #f0f4ff;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border: none;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        a.link-btn {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        a.link-btn:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        .stats {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #7f8c8d;
        }
        .main-grid {
            display: grid;
            gap: 20px;
        }
        .description-card .card-header {
            font-size: 18px;
        }
        .description-card p {
            margin: 0 0 10px 0;
            color: #333;
            line-height: 1.45;
        }
        .main-grid .card { display:flex; flex-direction:column; }
        .main-grid .card .graph-container { flex: 1 1 auto; }
        .description-body { background: white; padding: 20px; border-radius: 0 0 12px 12px; display:flex; flex-direction:column; justify-content:center; }
        @media (min-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
            .main-grid .card { min-height: 420px; }
            .graph-container { height: 100%; }
        }
        @media (max-width: 768px) {
            .graph-container {
                height: 350px;
            }
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GPUutje kopen?</h1>
        <p id="lastUpdate">Data loading...</p>
    </div>

    <div class="stats">
        <strong>Stats:</strong> <span id="statsText">Loading...</span>
    </div>

    <div class="main-grid">
        <!-- Tokens vs Price -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Tokens/s vs Avg Price</span>
                <select class="form-select form-select-sm" id="tokensDaysSelect" style="width: 200px;">
                    <option value="14">Last 14 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <div id="tokensGraph" class="graph-container"></div>
        </div>

        <!-- VRAM vs Price -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>VRAM vs Avg Price</span>
                <select class="form-select form-select-sm" id="vramDaysSelect" style="width: 200px;">
                    <option value="14">Last 14 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <div id="vramGraph" class="graph-container"></div>
        </div>

        <!-- Price Graph -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Price Trend</span>
                <div style="display:flex; gap:8px; align-items:center;">
                    <select class="form-select form-select-sm" id="gpuSelect" style="width: 250px;">
                        <option>Loading GPUs...</option>
                    </select>
                    <select class="form-select form-select-sm" id="priceGroupSelect" style="width: 140px;">
                        <option value="14d">Last 14 Days</option>
                        <option value="30d" selected>Last 30 Days</option>
                        <option value="1y">Last Year</option>
                    </select>
                </div>
            </div>
            <div id="priceGraph" class="graph-container"></div>
        </div>

        <!-- Description -->
        <div class="card description-card">
            <div class="card-header">GPUutje kopen!</div>
            <div class="description-body">
                <p>Dit dashboard zoekt en houdt automatisch aanbiedingen op Marktplaats bij voor een vaste lijst GPUs. Zo kun je zien hoeveel geld er nu ongeveer gevraagd wordt voor welke kaarten, en welke kaarten kosten-efficient zijn voor LLM toepassingen. Klik op een datapunt om naar de goedkoopste listing te gaan van die GPU op dit moment, of gebruik de zoek tool hier beneden om gevonden advertenties op specifieke criteria te filteren. </p>
                <p>VRAM en tokens/s komen uit een benchmarklijst; niet-geteste kaarten krijgen een geschatte tokens/s op basis van vergelijkbare modellen.</p>
                <p><strong>Let op:</strong> Deze website verzamelt alleen aanbiedingen en geeft statistieken op basis van aannames. De aankoop is altijd 100% je eigen verantwoordelijkheid. Zie <a href="https://github.com/XiongjieDai/GPU-Benchmarks-on-LLM-Inference" target="_blank">GPU-Benchmarks-on-LLM-Inference</a> voor de bron.</p>
                <p></p>
                <p><i>Gemaakt door Steven Jelsma</i></p>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="card">
        <div class="card-header">Search Results</div>
        <div style="background: white; padding: 20px; border-radius: 0 0 12px 12px;">
            <div class="controls">
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <label>Min VRAM (GB)</label>
                        <input type="number" class="form-control" id="minVram" min="0" value="0" step="1">
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <label>Min Tokens/s</label>
                        <input type="number" class="form-control" id="minTokens" min="0" value="0" step="1">
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <label>Max Price (€)</label>
                        <input type="number" class="form-control" id="maxPrice" min="0" value="999999" step="100">
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <label>Search</label>
                        <input type="text" class="form-control" id="searchBox" placeholder="Search titles...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6 col-lg-3 mb-2">
                        <label>Sort By</label>
                        <select id="sortBySelect" class="form-select">
                            <option value="timestamp" selected>Newest</option>
                            <option value="price">Price</option>
                            <option value="type">GPU</option>
                            <option value="vram">VRAM</option>
                            <option value="tokens">Tokens/s</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <label>Order</label>
                        <select id="sortOrderSelect" class="form-select">
                            <option value="desc" selected>Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <label>Show</label>
                        <select id="pageSizeSelect" class="form-select">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2 d-flex align-items-end">
                        <button class="btn btn-primary" id="filterBtn">Apply Filters</button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>GPU Model</th>
                            <th>Title</th>
                            <th>Price (€)</th>
                            <th>Link</th>
                            <th>Posted</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentGpuList = [];

        async function loadGpus() {
            const resp = await fetch("/api/gpus");
            currentGpuList = await resp.json();
            
            const select = document.getElementById("gpuSelect");
            select.innerHTML = currentGpuList.map(gpu => 
                `<option value="${gpu.name}">${gpu.name}</option>`
            ).join("");
            
            select.addEventListener("change", updatePriceGraph);
            updatePriceGraph();
        }

        async function updateStats() {
            const resp = await fetch("/api/stats");
            const stats = await resp.json();
            
            const date = new Date(stats.last_updated);
            document.getElementById("lastUpdate").textContent = 
                `Last updated: ${date.toLocaleString()}`;
            
            let gpuInfo = Object.entries(stats.gpu_counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name, count]) => `${name} (${count})`)
                .join(" | ");
            
            document.getElementById("statsText").textContent = 
                `Total Results: ${stats.total_results} | Top: ${gpuInfo}`;
        }

        async function updatePriceGraph() {
            const gpu = document.getElementById("gpuSelect").value;
            const span = document.getElementById("priceGroupSelect").value || '30d';
            const resp = await fetch(`/api/price-history/${encodeURIComponent(gpu)}?agg=min&span=${span}`);
            const data = await resp.json();
            
            const trace = {
                x: data.dates,
                y: data.prices,
                type: "scatter",
                mode: "lines+markers",
                fill: "tozeroy",
                line: {color: "#667eea", width: 2},
                marker: {size: 6, color: "#667eea"},
                hovertemplate: "<b>%{x}</b><br>€%{y:.2f}<extra></extra>",
            };
            
            const layout = {
                title: `Price History: ${gpu}`,
                xaxis: {title: "Date", type: 'date', tickformat: "%d/%m"},
                yaxis: {title: "Price (€)"},
                hovermode: "x unified",
                margin: {l: 50, r: 20, t: 40, b: 40},
                plot_bgcolor: "#fafbfc",
                paper_bgcolor: "white",
            };
            
            Plotly.newPlot("priceGraph", [trace], layout, {responsive: true});
        }

        async function updateScatterGraph(graphId, metric, daysSelect) {
            const days = document.getElementById(daysSelect).value || '30';
            const resp = await fetch(`/api/scatter-data?metric=${metric}&days=${days}`);
            const data = await resp.json();

            const points = data.points;

            // Separate tested and estimated points
            const tested = points.filter(p => p.tokens_tested === true);
            const estimated = points.filter(p => p.tokens_tested === false);

            // Helper function to create hover text
            function createHoverText(p, metric) {
                const tokensLabel = p.tokens_tested ? `${p.tokens.toFixed(2)} tokens/s` : `${p.tokens.toFixed(2)} tokens/s (est.)`;
                const metricValue = metric === "vram" ? `${p.vram} GB vram` : tokensLabel;
                const otherValue = metric === "vram" ? tokensLabel : `${p.vram} GB vram`;
                return `<b>${p.gpu}</b><br>${otherValue}<br>${metricValue}`;
            }

            const traces = [];

            // Tested GPUs trace
            if (tested.length > 0) {
                const testedTrace = {
                    x: tested.map(p => p.quality),
                    y: tested.map(p => p.price),
                    customdata: tested.map(p => p.lowest ? p.lowest.link : null),
                    mode: "markers",
                    type: "scatter",
                    text: tested.map(p => createHoverText(p, metric)),
                    marker: {
                        size: 8,
                        color: "#667eea",
                        opacity: 0.8,
                    },
                    hovertemplate: "%{text}<extra></extra>",
                    name: "Tested",
                };
                traces.push(testedTrace);
            }

            // Estimated GPUs trace (different color)
            if (estimated.length > 0) {
                const estimatedTrace = {
                    x: estimated.map(p => p.quality),
                    y: estimated.map(p => p.price),
                    customdata: estimated.map(p => p.lowest ? p.lowest.link : null),
                    mode: "markers",
                    type: "scatter",
                    text: estimated.map(p => createHoverText(p, metric)),
                    marker: {
                        size: 8,
                        color: "#a78bfa",
                        opacity: 0.6,
                    },
                    hovertemplate: "%{text}<extra></extra>",
                    name: "Estimated",
                };
                traces.push(estimatedTrace);
            }

            const xLabel = metric === "vram" ? "VRAM (GB)" : "Tokens/s";
            const layout = {
                xaxis: {title: xLabel, gridcolor: "#e0e0e0"},
                yaxis: {title: "Avg Price (€)", gridcolor: "#e0e0e0"},
                hovermode: "closest",
                margin: {l: 50, r: 20, t: 40, b: 40},
                plot_bgcolor: "#fafbfc",
                paper_bgcolor: "white",
                showlegend: true,
            };

            await Plotly.newPlot(graphId, traces, layout, {responsive: true});

            // Open lowest listing when user clicks a point
            const graphElem = document.getElementById(graphId);
            graphElem.on('plotly_click', function(eventData){
                if (!eventData || !eventData.points || !eventData.points.length) return;
                const pt = eventData.points[0];
                const link = pt.customdata || (pt.data && pt.data.customdata && pt.data.customdata[pt.pointNumber]);
                if (link) {
                    window.open(link, '_blank');
                }
            });
        }

        async function loadResults() {
            const minVram = document.getElementById("minVram").value;
            const minTokens = document.getElementById("minTokens").value;
            const maxPrice = document.getElementById("maxPrice").value;
            const search = document.getElementById("searchBox").value;
            
            const sortBy = document.getElementById('sortBySelect').value;
            const sortOrder = document.getElementById('sortOrderSelect').value;

            const params = new URLSearchParams({
                min_vram: minVram,
                min_tokens: minTokens,
                max_price: maxPrice,
                search: search,
                sort_by: sortBy,
                order: sortOrder,
            });

            const resp = await fetch(`/api/results?${params}`);
            const results = await resp.json();
            const pageSize = parseInt(document.getElementById('pageSizeSelect')?.value || '10', 10);
            const limited = results.slice(0, pageSize);
            
            const tbody = document.getElementById("resultsTable");
            if (results.length === 0) {
                tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center text-muted\">No results found</td></tr>";
                return;
            }
            
            tbody.innerHTML = limited.map(r => `
                <tr>
                    <td><strong>${r.gpu}</strong><br><small class="text-muted">VRAM: ${r.vram}GB, Tokens/s: ${r.tokens}</small></td>
                    <td>${r.title.substring(0, 60)}</td>
                    <td><strong>€${r.price}</strong></td>
                    <td><a href="${r.link}" target="_blank" class="link-btn">View</a></td>
                    <td><small>${new Date(r.timestamp).toLocaleDateString()}</small></td>
                </tr>
            `).join("");
        }

        document.getElementById("filterBtn").addEventListener("click", loadResults);
        document.getElementById("priceGroupSelect").addEventListener("change", updatePriceGraph);
        
        document.getElementById("vramDaysSelect").addEventListener("change", () => 
            updateScatterGraph("vramGraph", "vram", "vramDaysSelect")
        );
        
        document.getElementById("tokensDaysSelect").addEventListener("change", () => 
            updateScatterGraph("tokensGraph", "tokens", "tokensDaysSelect")
        );

        const pageSizeElem = document.getElementById('pageSizeSelect');
        if (pageSizeElem) pageSizeElem.addEventListener('change', loadResults);

        // Initial load
        async function init() {
            await updateStats();
            await loadGpus();
            await updateScatterGraph("tokensGraph", "tokens", "tokensDaysSelect");
            await updateScatterGraph("vramGraph", "vram", "vramDaysSelect");
            await loadResults();
            
            // Refresh stats every 10 seconds
            setInterval(updateStats, 10000);
        }

        init();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
